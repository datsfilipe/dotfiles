name: build

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        hostname: [dtsf-pc, dtsf-laptop, dtsf-server]

    steps:
      - name: Fast Disk Cleanup
        run: |
          echo "Disk space before cleanup:"
          df -h /
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          echo "Disk space after cleanup:"
          df -h /
          
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: recursive

      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY_FOR_SUBMODULES }}

      - name: Prepare /home/dtsf
        run: |
          set -euo pipefail
          sudo mkdir -p /home/dtsf
          sudo chown -R $USER /home/dtsf
          rm -rf /home/dtsf/.dotfiles
          cp -a "${GITHUB_WORKSPACE}/." /home/dtsf/.dotfiles
          git -C /home/dtsf/.dotfiles config --global --add safe.directory /home/dtsf/.dotfiles

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v14
        with:
          extra-conf: |
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
            auto-optimise-store = false
            # Performance tweak: Disable fsync for faster unpacking on CI
            fsync-metadata = false

      - name: Configure Cachix
        uses: cachix/cachix-action@v15
        with:
          name: datsfilipe-dotfiles
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

      - name: Ensure nix/cachix in PATH
        run: |
          set -euo pipefail
          if [ -f /home/runner/.nix-profile/etc/profile.d/nix.sh ]; then
            . /home/runner/.nix-profile/etc/profile.d/nix.sh
          fi
          if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix.sh ]; then
            . /nix/var/nix/profiles/default/etc/profile.d/nix.sh
          fi
          export PATH="$HOME/.nix-profile/bin:/nix/var/nix/profiles/default/bin:$PATH"
          which nix || true
          which cachix || true

      - name: Build toplevel
        id: build
        run: |
          set -euo pipefail
          cd /home/dtsf/.dotfiles
          
          nix build .#nixosConfigurations.${{ matrix.hostname }}.config.system.build.toplevel \
            --print-build-logs \
            --accept-flake-config \
            --max-jobs 4
          
          if [ -L ./result ]; then
            RESULT_PATH=$(readlink -f ./result)
            echo "result_path=$RESULT_PATH" >> $GITHUB_OUTPUT
          else
            echo "result_path=" >> $GITHUB_OUTPUT
          fi
