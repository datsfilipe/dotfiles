name: build

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        host: [dtsf-pc]
    steps:
      - name: checkout repository
        uses: actions/checkout@v4

      - name: set up nix
        uses: cachix/install-nix-action@v22
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: load env
        uses: HatsuneMiku3939/direnv-action@v1.0.7

      - name: generate flake
        run: nix run nixpkgs#just generate-flake

      - name: setup git submodules
        env:
          GIT_USER: ${{ secrets.GIT_USER }}
          GIT_TOKEN: ${{ secrets.GIT_TOKEN }}
        run: |
          git config --global url."https://${GIT_USER}:${GIT_TOKEN}@github.com/".insteadOf "git@github.com:"
          git submodule update --init --recursive

      - name: setup hardware configuration
        run: |
          rm -rf ./hosts/${{ matrix.host }}/hardware-configuration.nix
          nix-shell -p nixos-install-tools
          nixos-generate-config --dir ./hosts/${{ matrix.host }}
        
      - name: build 
        run: nix run github:nix-community/nixos-generators -- -f iso --flake .#${{ matrix.host }} --option build-use-substitutes true
